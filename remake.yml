sources:
  - R/

packages:
  ## data I/O
  - readxl
  - readr
  - feather
  - RSQLite
  - storr
  - bold
  - tibble
  ## geospatial tools
  - raster
  - sp
  - maptools
  - maps
  - geojsonio
  - lawn
  ## data manipulation
  - dplyr
  - tidyr
  - lubridate
  - purrr
  ## data visualization
  - ggplot2
  - viridis
  - scales
  ## APIs
  - taxizesoap
  - ridigbio
  - marmap
  - robis
  - rgbif
  - ritis
  ## other utils
  - rmarkdown
  - labmanager
  - progress


targets:

  all:
    depends:
      - manuscript.pdf
      - manuscript.docx


### Kozloff species list--------------------------------------------------------

  kozloff_species:
    command: get_kozloff_species("data-raw/Kozloff/Koz_checklist.xlsx")

  kozloff_worms:
    command: add_worms(kozloff_species)

  kozloff_bold:
    command: find_bold_records(kozloff_worms)

  ## iDigbio -------------------------------------------------------------------
  kozloff_idigbio_raw:
    command: fetch_spp_from_idigbio(kozloff_worms)

  kozloff_idigbio:
    command: filter_raw_records(kozloff_idigbio_raw)

  kozloff_idigbio_in_us:
    command: is_in_eez_records(kozloff_idigbio, map_usa)

  kozloff_spp_records_idigbio:
    command: get_n_records_in_db(kozloff_worms, kozloff_idigbio_in_us, field_name=I("n_idigbio"))

  ## OBIS ----------------------------------------------------------------------
  data/kozloff_obis.feather:
    command: fetch_spp_from_obis(kozloff_worms, "data/kozloff_obis.feather")

  kozloff_obis:
    command: filter_raw_records("data/kozloff_obis.feather")

  kozloff_obis_in_us:
    command: is_in_eez_records(kozloff_obis, map_usa)

  kozloff_spp_records_obis:
    command: get_n_records_in_db(kozloff_worms, kozloff_obis_in_us, field_name=I("n_obis"))

  ## GBIF ----------------------------------------------------------------------
  data/kozloff_gbif.feather:
    command: fetch_spp_from_gbif(kozloff_worms, feather_path="data/kozloff_gbif.feather")

  kozloff_gbif:
    command: filter_raw_records("data/kozloff_gbif.feather")

  kozloff_gbif_in_us:
    command: is_in_eez_records(kozloff_gbif, map_usa)

  kozloff_spp_records_gbif:
    command: get_n_records_in_db(kozloff_worms, kozloff_gbif_in_us, field_name=I("n_gbif"))

  ## overlap with iDigBio query made by geography
  figures/map_kozloff_idigbio.pdf:
    command: map_kozloff(kozloff_idigbio)
    plot:
      height: 8
      width: 12

  ## figures -------------------------------------------------------------------
  figures/kozloff_not_in_idigbio.pdf:
    command: plot_spp_not_in_idigbio(kozloff_spp_records_idigbio)
    plot: true


### Gulf of Mexico species list ------------------------------------------------

  gom_species_raw:
    command: get_gom_species(file="data-raw/GOM/BioGoMx.xls")

  gom_species:
    command: standardize_gom(gom_species_raw)

  gom_worms:
    command: add_worms(gom_species)

  gom_bold:
    command: find_bold_records(gom_worms)

  ## iDigBio -------------------------------------------------------------------
  gom_idigbio_raw:
    command: fetch_spp_from_idigbio(gom_worms)

  gom_idigbio:
    command: filter_raw_records(gom_idigbio_raw)

  gom_idigbio_in_us:
    command: is_in_eez_records(gom_idigbio, map_usa)

  gom_spp_records_idigbio:
    command: get_n_records_in_db(gom_worms, gom_idigbio_in_us, field_name=I("n_idigbio"))

  ## OBIS ----------------------------------------------------------------------
  data/gom_obis.feather:
    command: fetch_spp_from_obis(gom_worms, "data/gom_obis.feather")

  gom_obis:
    command: filter_raw_records("data/gom_obis.feather")

  gom_obis_in_us:
    command: is_in_eez_records(gom_obis, map_usa)

  gom_spp_records_obis:
    command: get_n_records_in_db(gom_worms, gom_obis_in_us, field_name=I("n_obis"))

  ## GBIF ----------------------------------------------------------------------
  data/gom_gbif.feather:
    command: fetch_spp_from_gbif(gom_worms, feather_path="data/gom_gbif.feather")

  gom_gbif:
    command: filter_raw_records("data/gom_gbif.feather")

  gom_gbif_in_us:
    command: is_in_eez_records(gom_gbif, map_usa)

  gom_spp_records_gbif:
    command: get_n_records_in_db(gom_worms, gom_gbif_in_us, field_name=I("n_gbif"))

  ## figures -------------------------------------------------------------------
  figures/gom_not_in_idigbio.pdf:
    command: plot_spp_not_in_idigbio(gom_spp_records_idigbio)
    plot: true

  figures/combined_not_in_idigbio.pdf:
    command: plot_spp_not_in_idigbio_combined(kozloff_spp_records_idigbio, gom_spp_records_idigbio)
    plot:
      height: 8
      width: 12

### ITIS common names of mollusks ----------------------------------------------

  itis_common_names:
    command: get_common_names()

  itis_binomial:
    command: binomial_common_names(itis_common_names)

  itis_worms:
    command: add_worms(itis_binomial)

  itis_bold:
    command: find_bold_records(itis_worms)

  itis_idigbio:
    command: fetch_spp_from_idigbio(itis_worms)

  itis_spp_not_in_idigbio:
    command: spp_not_in_idigbio(itis_worms, itis_idigbio)

### IRL checklist --------------------------------------------------------------
  irl_species:
    command: read_irl_checklist(file="data-raw/IRL/irl_checklist.xlsx")

  irl_worms:
    command: add_worms(irl_species)

  irl_bold:
    command: find_bold_records(irl_worms)

  irl_idigbio:
    command: fetch_spp_from_idigbio(irl_worms)

  irl_obis:
    command: fetch_spp_from_obis(irl_worms)

### American mammals  ----------------------------------------------------------

  data/idigbio_mammals.feather:
    command: convert_to_feather("data-raw/vertebrates/idigbio_mammals_occurrence_raw.csv", feather_out="data/idigbio_mammals.feather")

  mammals_species_idigbio:
    command: read_idigbio_mammals("data/idigbio_mammals.feather")

  mammals_bold_idigbio:
    command: find_bold_records(mammals_species_idigbio, use_worms = I(FALSE))

  ## species list of mammals from the American Society of Mammologists
  ## (http://www.mammalsociety.org/mammals-list)
  ## downloaded on 2017-02-15
  mammals_species_asm:
    command: read_asm_mammals("data-raw/vertebrates/mammals_species_usa.csv")

  mammals_asm_idigbio_raw:
    command: asm_mammals_idigbio(mammals_species_asm)

  mammals_asm_idigbio:
    command: asm_mammals_idigbio_summary(mammals_species_asm, mammals_asm_idigbio_raw)

  mammals_asm_bold:
    ## this produces messages about not finding a valid WoRMS ID, but it's OK here as
    ## it happens as we are trying to look for synonyms in case there is no match
    command: find_bold_mammals(mammals_species_asm)

  mammals_asm_summary:
    command: asm_summary(mammals_asm_idigbio, mammals_asm_bold)


### get species list from the US using iDigBio ---------------------------------

  map_usa:
    command: get_map_usa("data-raw/USA-EEZ/eez.shp")

  idigbio_records_raw:
    command: fill_store_idigbio_by_geo(map_usa, use_cache=I(TRUE))

  idigbio_records:
    command: cleanup_idigbio_raw(idigbio_records_raw)

  idigbio_bold:
    command: find_bold_records(idigbio_records)

  idigbio_invert_summary:
    command: plot_idigbio_invert_summary(idigbio_records, idigbio_bold)

  idigbio_samples_through_time:
    command: make_knowledge_through_time_idigbio(idigbio_records)

  figures/plot_idigbio_samples_through_time.pdf:
    command: plot_cum_samples_through_time(idigbio_samples_through_time, facet=I(FALSE))
    plot: true

  figures/plot_idigbio_species_through_time.pdf:
    command: plot_cum_spp_through_time(idigbio_samples_through_time, facet=I(FALSE))
    plot: true

### summary tables
  # table_idigbio_species_sequenced:
  #   command: make_table_bold_records_per_idigbio_species(global=global_idigbio_species_with_bold_info, east_coast=east_idigbio_species_with_bold_info, west_coast=west_idigbio_species_with_bold_info, florida=florida_idigbio_species_with_bold_info)

  # figures/plot_idigbio_species_sequenced.pdf:
  #   command: make_plot_bold_records_per_idigbio_species(table_idigbio_species_sequenced)
  #   plot: true

  # idigbio_species_list_dates:
  #   command: assemble_idigbio_species_list_dates(global_idigbio_species_with_worms_info)
  #   depends: idigbio_records

  # figures/plot_idigbio_species_dates.pdf:
  #   command: make_plot_idigbio_records_per_date(idigbio_species_list_dates)
  #   plot:
  #     width: 12
  #     height: 8

  figures/proportion_barcoded.pdf:
    command: summary_bold_status(gom_bold, kozloff_bold, idigbio_bold)
    plot: true

  #table_records_per_species:
  #   command: make_table_records_per_species()
  #   depends: bold_records_for_idigbio_species


### plankton data
  plankton_ids:
    command: get_plankton_identifications()

  prop_plankton_with_species_match_by_phylum:
    command: calc_prop_plankton_with_species_match_by_phylum(plankton_ids)

  prop_plankton_with_multi_species_match:
    command: calc_prop_plankton_with_multi_species_match(plankton_ids)

  plankton_geo_distances:
    command: calc_plankton_geo_distances(plankton_ids)

### map sampling effort --------------------------------------------------------

  sampling_maps:
    depends:
      - figures/map_sampling_effort.pdf
      - figures/map_diversity.pdf
      - figures/map_sampling.pdf


  data_map_sampling_effort:
    command: make_data_map_sampling_effort(idigbio_records)
    #depends: idigbio_records

  data_map_diversity:
    command: make_data_map_diversity(idigbio_records)
    #depends: idigbio_records

  data_map_standardized_diversity:
    command: make_data_map_standardized_diversity(data_map_sampling_effort, data_map_diversity)

  figures/map_sampling_effort.pdf:
    command: make_heatmap_sampling(data_map_sampling_effort, I("Number of samples"))
    plot: true

  figures/map_diversity.pdf:
    command: make_heatmap_sampling(data_map_diversity, I("Number of species"))
    plot: true

  figures/map_sampling.pdf:
    command: make_heatmap_sampling(data_map_standardized_diversity, I("Diversity"))
    plot: true

  knowledge_through_time:
    command: make_knowledge_through_time(gom_idigbio_in_us, kozloff_idigbio_in_us, gom_gbif_in_us, kozloff_gbif_in_us, gom_worms, kozloff_worms)

  figures/cum_spp_through_time.pdf:
    command: plot_cum_spp_through_time(knowledge_through_time)
    plot: true

  figures/cum_samples_through_time.pdf:
    command: plot_cum_samples_through_time(knowledge_through_time)
    plot: true

  figures/new_spp_per_effort.pdf:
    command: plot_new_effort(knowledge_through_time)
    plot:
      width: 12
      height: 8

  figures/cum_frac_through_time.pdf:
    command: plot_cum_frac_through_time(knowledge_through_time)
    plot: true

  figures/change_trend_through_time.pdf:
    command: plot_change_trend_through_time(knowledge_through_time)
    plot:
      width: 12
      height: 8

### plot summary database ------------------------------------------------------

  summary_richness_per_db_gom:
    command: summarize_richness_per_db(gom_bold, gom_spp_records_idigbio, gom_spp_records_obis, gom_spp_records_gbif)

  figures/plot_richness_per_db_gom.pdf:
    command: plot_richness_per_db(summary_richness_per_db_gom, data_source=I("Gulf of Mexico"))
    plot:
      height: 10
      width: 8

  summary_richness_per_db_koz:
    command: summarize_richness_per_db(kozloff_bold, kozloff_spp_records_idigbio, kozloff_spp_records_obis, kozloff_spp_records_gbif)

  figures/plot_richness_per_db_koz.pdf:
    command: plot_richness_per_db(summary_richness_per_db_koz, data_source=I("Kozloff"))
    plot:
      height: 10
      width: 8

### plot sampling effort (correlation between number of samples vs number species

  figures/plot_sampling_effort.pdf:
    command: plot_sampling_effort(data_map_standardized_diversity)
    plot: true

### in text statistics ---------------------------------------------------------

  in_text_stats:
    depends:
      - stat_bold
      - prop_singleton_species
      - prop_species_not_collected_since_1980
      - n_spp_comparison

  # n_esus:
  #   command: calc_n_esus()

  # n_larvae:
  #   command: calc_n_larvae()

  prop_plankton_with_match:
    command: calc_prop_plankton_with_species_match(plankton_ids)

  stat_bold:
    command: make_stat_bold(gom_bold, kozloff_bold, gom_worms, kozloff_worms)

  prop_singleton_species:
    command: calc_prop_singleton_species(idigbio_records)

  prop_species_not_collected_since_1980:
    command: calc_prop_species_not_collected_since(idigbio_records, I(1980))

  n_spp_comparison:
    command: calc_n_spp_comparison(idigbio_samples_through_time)

  #prop_species_not_collected_since_1990:
  #  command: calc_prop_species_not_collected_since(idigbio_species_list_dates, I(1990))

### Manuscript --------------------------------------------------------------

  text_figures:
    depends:
      - figures/map_sampling_effort.pdf
      - figures/map_diversity.pdf
      - figures/proportion_barcoded.pdf
      - figures/plot_richness_per_db_koz.pdf
      - figures/plot_richness_per_db_gom.pdf

  manuscript.md:
    depends:
      - in_text_stats
    knitr: true

  manuscript.pdf:
    depends:
      - text_figures
    command: render("manuscript.md")

  manuscript.docx:
    command: render("manuscript.md", output_format=I("word_document"))
