sources:
  - R/

packages:
  - readxl
  - readr
  - dplyr
  - ggplot2
  - RSQLite
  - taxizesoap
  - storr
  - bold
  - tibble
  - tidyr
  - ridigbio
  - lubridate
  - viridis
  - rmarkdown
  - labmanager
  - raster
  - sp
  - maptools
  - maps
  - marmap

targets:
  all:
    depends:
      - manuscript.pdf
      - manuscript.docx

  irl_checklist:
    command: read_irl_checklist(file="data-raw/Species List Database Post V1.xlsx")

  data/bold_database.sqlite:
    command: create_bold_db(path=I("data-raw/BOLD"))

  joined_data:
    command: create_joined_data(irl_checklist, "data/bold_database.sqlite")

  species_list:
    command: join_species("data/bold_database.sqlite")
    depends: joined_data

  fill_synonym_store:
    command: get_synonym_store(irl_checklist)

  fill_classification_store:
    command: get_classification_store(irl_checklist)

  synonym_table:
    command: make_synonym_table(store_path=I("data/synonym_storr"), database_path=I("data/bold_database.sqlite"))
    depends: fill_synonym_store

  synonym_list:
    command: join_synonyms("data/bold_database.sqlite")
    depends: synonym_table

  fill_bold_specimen_store:
    command: get_bold_specimens_store(irl_checklist)

  irl_species_in_bold:
    command: get_irl_species_in_bold()
    depends:
      - fill_synonym_store
      - fill_classification_store
      - fill_bold_specimen_store

  barcode_data:
    command: assemble_barcode_data(worms="data-raw/20160929_worms_stats.csv", bold="data-raw/20160929_bold_bin_stats.csv", other="data-raw/20160929_other_taxa_stats.csv")

  figures/plot_barcode_data.pdf:
    command: plot_barcoded_species(barcode_data)
    plot: true

  #### get BOLD specimen data for most marine groups ---------------------------
  acanthocephala_raw:
    command: bold_specimens_raw(I("Acanthocephala"))
    cleanup_level: purge

  brachiopoda_raw:
    command: bold_specimens_raw(I("Brachiopoda"))
    cleanup_level: purge

  cephalorhyncha_raw:
    command: bold_specimens_raw(I("Cephalorhyncha"))
    cleanup_level: purge

  cycliophora_raw:
    command: bold_specimens_raw(I("Cycliophora"))
    cleanup_level: purge

  dicyemida_raw:
    command: bold_specimens_raw(I("Rhombozoa"))
    cleanup_level: purge

  hemichordata_raw:
    command: bold_specimens_raw(I("Hemichordata"))
    cleanup_level: purge

  ## TODO -- nematoda_raw:

  orthonectida_raw:
    command: bold_specimens_raw(I("Orthonectida"))
    cleanup_level: purge

  placozoa_raw:
    command: bold_specimens_raw(I("Placozoa"))
    cleanup_level: purge

  platyhelminthes_raw:
    command: bold_specimens_raw(I("Platyhelminthes"))
    cleanup_level: purge

  xenacoelomorpha_raw:
    command: bold_specimens_raw(I("Xenacoelomorpha"))
    cleanup_level: purge

  echinodermata_raw:
    command: bold_specimens_raw(I("Echinodermata"))
    cleanup_level: purge

  polychaeta_raw:
    command: bold_specimens_raw(I("Polychaeta"))
    cleanup_level: purge

  cnidaria_raw:
    command: bold_specimens_raw(I("Cnidaria"))
    cleanup_level: purge

  nemertea_raw:
    command: bold_specimens_raw(I("Nemertea"))
    cleanup_level: purge

  ctenophora_raw:
    command: bold_specimens_raw(I("Ctenophora"))
    cleanup_level: purge

  porifera_raw:
    command: bold_specimens_raw(I("Porifera"))
    cleanup_level: purge

  malacostraca_raw:
    command: bold_specimens_raw(I("Malacostraca"))

  sipuncula_raw:
    command: bold_specimens_raw(I("Sipuncula"))

  chaetognatha_raw:
    command: bold_specimens_raw(I("Chaetognatha"))

  mollusca_raw:
    command: bold_specimens_raw(I("Mollusca"))
    cleanup_level: purge

  phoronida_raw:
    command: bold_specimens_raw(I("Phoronida"))
    cleanup_level: purge

  entoprocta_raw:
    command: bold_specimens_raw(I("Entoprocta"))
    cleanup_level: purge

  bryozoa_raw:
    command: bold_specimens_raw(I("Bryozoa"))
    cleanup_level: purge

  gnathostomulida_raw:
    command: bold_specimens_raw(I("Gnathostomulida"))
    cleanup_level: purge

  gastrotricha_raw:
    command: bold_specimens_raw(I("Gastrotricha"))
    cleanup_level: purge

  mammalia_raw:
    command: bold_specimens_raw(I("Mammalia"))
    cleanup_level: purge

  reptilia_raw:
    command: bold_specimens_raw(I("Reptilia"))
    cleanup_level: purge

  amphibia_raw:
    command: bold_specimens_raw(I("Amphibia"))
    cleanup_level: purge

  aves_raw:
    command: bold_specimens_raw(I("Aves"))
    cleanup_level: purge

  bold_data:
    command: assemble_bold_data(acanthocephala_raw, brachiopoda_raw, cephalorhyncha_raw, cycliophora_raw, dicyemida_raw, hemichordata_raw, orthonectida_raw, platyhelminthes_raw, xenacoelomorpha_raw, echinodermata_raw, polychaeta_raw, cnidaria_raw, nemertea_raw, ctenophora_raw, porifera_raw, malacostraca_raw, chaetognatha_raw, mollusca_raw, phoronida_raw, entoprocta_raw, bryozoa_raw, gnathostomulida_raw, mammalia_raw, reptilia_raw, amphibia_raw, aves_raw)

  stats_bold_data:
    command: get_stats_bold(bold_data)

  table_proportion_barcoded_by_phylum:
    command: make_table_proportion_barcoded_by_phylum(stats_bold_data, worms="data-raw/20160929_worms_stats.csv", others="data-raw/20160929_other_taxa_stats.csv")

  figures/proportion_barcoded_by_phylum.pdf:
    command: plot_proportion_barcoded_by_phylum(table_proportion_barcoded_by_phylum)
    plot: true

  level_identification:
    command: get_level_identification(bold_data)

  figures/proportion_level_identification.pdf:
    command: plot_level_identification(level_identification)
    plot: true

### Kozloff species list--------------------------------------------------------

  kozloff_species:
    command: get_kozloff_species("data-raw/Kozloff/Koz_checklist.xlsx")

  # overlap with iDigBio query made by geography
  kozloff_idigbio_overlap:
    command: calc_kozloff_idigbio_overlap(kozloff_species, global_idigbio_species_with_worms_info)

  # get idigbio records based on species names
  kozloff_idigbio_query:
    command: fetch_kozloff_from_idigbio(kozloff_species)

  kozloff_idigbio_species_list:
    command: extract_species_from_kozloff_idigbio(kozloff_idigbio_query, kozloff_species)

  kozloff_idigbio_with_worms_info:
    command: add_worms(kozloff_idigbio_species_list)

  kozloff_bold:
    command: add_bold_info(kozloff_idigbio_with_worms_info)

  figures/map_kozloff_idigbio.pdf:
    command: map_kozloff(kozloff_idigbio_query)
    plot:
      height: 8
      width: 12

  # number/proportion of species listed in Kozloff, but not found in iDigBio
  # (complete list, beyond the search done on geography)
  kozloff_not_in_idigbio:
    command: data_kozloff_not_in_idigbio(kozloff_species, kozloff_idigbio_query)

  prop_kozloff_not_in_idigbio:
    command: calc_prop_kozloff_not_in_idigbio(kozloff_not_in_idigbio)

  figures/kozloff_not_in_idigbio.pdf:
    command: graph_kozloff_not_in_idigbio(kozloff_not_in_idigbio)
    plot: true

### ITIS common names of mollusks ----------------------------------------------

  itis_common_names:
    command: get_common_names()

  itis_binomial:
    command: binomial_common_names(itis_common_names)

  itis_worms:
    command: add_worms(itis_binomial)

  itis_bold:
    command: add_bold(itis_worms)

### Gulf of Mexico species list ------------------------------------------------

  gom_species:
    command: get_gom_species(file="data-raw/GOM/BioGoMx.xls")

  gom_worms:
    command: add_worms(gom_species)

  gom_bold:
    command: add_bold(gom_worms)

  gom_idigbio:
    command: fetch_gom_from_idigbio(gom_worms)

### get species list from the US using iDigBio ---------------------------------

  idigbio_records:
    depends:
      - acanthocephala_idigbio_records
      - brachiopoda_idigbio_records
      - cephalorhyncha_idigbio_records
      - cycliophora_idigbio_records
      - dicyemida_idigbio_records
      - hemichordata_idigbio_records
      - orthonectida_idigbio_records
      - platyhelminthes_idigbio_records
      - xenacoelomorpha_idigbio_records
      - polychaeta_idigbio_records
      - porifera_idigbio_records
      - decapoda_idigbio_records
      - entoprocta_idigbio_records
      - bryozoa_idigbio_records
      - gnathostomulida_idigbio_records
      - echinodermata_idigbio_records
      - nemertea_idigbio_records
      - phoronida_idigbio_records
      - ctenophora_idigbio_records
      - chaetognatha_idigbio_records
      - cnidaria_idigbio_records
      - mollusca_idigbio_records


  acanthocephala_idigbio_records:
    command: assemble_idigbio_records(I("Acanthocephala"), I("phylum"))

  brachiopoda_idigbio_records:
    command: assemble_idigbio_records(I("Brachiopoda"), I("phylum"))

  cephalorhyncha_idigbio_records:
    command: assemble_idigbio_records(I("Cephalorhyncha"), I("phylum"))

  cycliophora_idigbio_records:
    command: assemble_idigbio_records(I("Cycliophora"), I("phylum"))

  dicyemida_idigbio_records:
    command: assemble_idigbio_records(I("Dicyemida"), I("phylum"))

  hemichordata_idigbio_records:
    command: assemble_idigbio_records(I("Hemichordata"), I("phylum"))

  orthonectida_idigbio_records:
    command: assemble_idigbio_records(I("Orthonectida"), I("phylum"))

  platyhelminthes_idigbio_records:
    command: assemble_idigbio_records(I("Platyhelminthes"), I("phylum"))

  xenacoelomorpha_idigbio_records:
    command: assemble_idigbio_records(I("Xenacoelomorpha"), I("phylum"))

  polychaeta_idigbio_records:
    command: assemble_idigbio_records(I("Polychaeta"), I("class"))

  porifera_idigbio_records:
    command: assemble_idigbio_records(I("Porifera"), I("phylum"))

  entoprocta_idigbio_records:
    command: assemble_idigbio_records(I("Entoprocta"), I("phylum"))

  bryozoa_idigbio_records:
    command: assemble_idigbio_records(I("Bryozoa"), I("phylum"))

  gnathostomulida_idigbio_records:
    command: assemble_idigbio_records(I("Gnathostomulida"), I("phylum"))

  decapoda_idigbio_records:
    command: assemble_idigbio_records(I("Decapoda"), I("order"))

  echinodermata_idigbio_records:
    command: assemble_idigbio_records(I("Echinodermata"), I("phylum"))

  nemertea_idigbio_records:
    command: assemble_idigbio_records(I("Nemertea"), I("phylum"))

  phoronida_idigbio_records:
    command: assemble_idigbio_records(I("Phoronida"), I("phylum"))

  ctenophora_idigbio_records:
    command: assemble_idigbio_records(I("Ctenophora"), I("phylum"))

  chaetognatha_idigbio_records:
    command: assemble_idigbio_records(I("Chaetognatha"), I("phylum"))

  cnidaria_idigbio_records:
    command: assemble_idigbio_records(I("Cnidaria"), I("phylum"))

  mollusca_idigbio_records:
    command: assemble_idigbio_records(I("Mollusca"), I("phylum"))

### global list
  global_idigbio_species_list:
    command: assemble_idigbio_species_list(geo_filter=I("global"))
    depends: idigbio_records

  global_idigbio_species_with_worms_info:
    command: add_worms(global_idigbio_species_list)

  global_idigbio_species_with_bold_info:
    command: add_bold(global_idigbio_species_with_worms_info)

### east coast list
  east_idigbio_species_list:
    command: assemble_idigbio_species_list(geo_filter=I("east_coast"))
    depends: idigbio_records

  east_idigbio_species_with_worms_info:
    command: add_worms(east_idigbio_species_list)

  east_idigbio_species_with_bold_info:
    command: add_bold(east_idigbio_species_with_worms_info)

### west coast list
  west_idigbio_species_list:
    command: assemble_idigbio_species_list(geo_filter=I("west_coast"))
    depends: idigbio_records

  west_idigbio_species_with_worms_info:
    command: add_worms(west_idigbio_species_list)

  west_idigbio_species_with_bold_info:
    command: add_bold(west_idigbio_species_with_worms_info)

### florida list
  florida_idigbio_species_list:
    command: assemble_idigbio_species_list(geo_filter=I("florida"))
    depends: idigbio_records

  florida_idigbio_species_with_worms_info:
    command: add_worms(florida_idigbio_species_list)

  florida_idigbio_species_with_bold_info:
    command: add_bold(florida_idigbio_species_with_worms_info)

### summary tables
  table_idigbio_species_sequenced:
    command: make_table_bold_records_per_idigbio_species(global=global_idigbio_species_with_bold_info, east_coast=east_idigbio_species_with_bold_info, west_coast=west_idigbio_species_with_bold_info, florida=florida_idigbio_species_with_bold_info)

  figures/plot_idigbio_species_sequenced.pdf:
    command: make_plot_bold_records_per_idigbio_species(table_idigbio_species_sequenced)
    plot: true

  idigbio_species_list_dates:
    command: assemble_idigbio_species_list_dates(global_idigbio_species_with_worms_info)
    depends: idigbio_records

  figures/plot_idigbio_species_dates.pdf:
    command: make_plot_idigbio_records_per_date(idigbio_species_list_dates)
    plot:
      width: 12
      height: 8

  figures/proportion_barcoded.pdf:
    command: make_plot_proportion_barcoded(table_idigbio_species_sequenced, prop_plankton_with_species_match_by_phylum)
    plot: true

  #table_records_per_species:
  #   command: make_table_records_per_species()
  #   depends: bold_records_for_idigbio_species

  proportion_barcoded_summary:
    command: make_proportion_barcoded_summary(table_proportion_barcoded_by_phylum, table_idigbio_species_sequenced)

### plankton data
  plankton_ids:
    command: get_plankton_identifications()

  prop_plankton_with_species_match_by_phylum:
    command: calc_prop_plankton_with_species_match_by_phylum(plankton_ids)

  prop_plankton_with_multi_species_match:
    command: calc_prop_plankton_with_multi_species_match(plankton_ids)

  plankton_geo_distances:
    command: calc_plankton_geo_distances(plankton_ids)

### map sampling effort --------------------------------------------------------

  sampling_maps:
    depends:
      - figures/map_sampling_effort.pdf
      - figures/map_diversity.pdf
      - figures/map_sampling.pdf


  data_map_sampling_effort:
    command: make_data_map_sampling_effort()
    depends: idigbio_records

  data_map_diversity:
    command: make_data_map_diversity()
    depends: idigbio_records

  data_map_standardized_diversity:
    command: make_data_map_standardized_diversity(data_map_sampling_effort, data_map_diversity)

  figures/map_sampling_effort.pdf:
    command: make_heatmap_sampling(data_map_sampling_effort, I("Number of samples"))
    plot: true

  figures/map_diversity.pdf:
    command: make_heatmap_sampling(data_map_diversity, I("Number of species"))
    plot: true

  figures/map_sampling.pdf:
    command: make_heatmap_sampling(data_map_standardized_diversity, I("Diversity"))
    plot: true

### plot sampling effort -------------------------------------------------------

  figures/plot_sampling_effort.pdf:
    command: plot_sampling_effort(data_map_standardized_diversity)
    plot: true

### in text statistics ---------------------------------------------------------

  in_text_stats:
    depends:
      - average_prop_species_seq
      - n_esus
      - n_larvae
      - prop_plankton_with_match
      - prop_singleton_species
      - prop_species_not_collected_since_1950

  average_prop_species_seq:
    command: calc_average_prop_species_seq(table_idigbio_species_sequenced)

  n_esus:
    command: calc_n_esus()

  n_larvae:
    command: calc_n_larvae()

  prop_plankton_with_match:
    command: calc_prop_plankton_with_species_match(plankton_ids)

  prop_singleton_species:
    command: calc_prop_singleton_species(idigbio_species_list_dates)

  prop_species_not_collected_since_1950:
    command: calc_prop_species_not_collected_since(idigbio_species_list_dates, I(1950))

  prop_species_not_collected_since_1990:
    command: calc_prop_species_not_collected_since(idigbio_species_list_dates, I(1990))

### Manuscript -----------------------------------------------------------------

  manuscript.md:
    depends: in_text_stats
    knitr: true

  manuscript.pdf:
    command: render("manuscript.md")

  manuscript.docx:
    command: render("manuscript.md", output_format=I("word_document"))
