sources:
  - R/

packages:
  ## data I/O
  - readxl
  - readr
  - feather
  - RSQLite
  - storr
  - tibble
  ## geospatial tools
  - raster
  - sp
  - maptools
  - maps
  - geojsonio
  - lawn
  ## data manipulation
  - dplyr
  - dbplyr
  - tidyr
  - lubridate
  - purrr
  - lazyeval
  ## data visualization
  - grid
  - ggplot2
  - cowplot
  - viridis
  - scales
  - hrbrthemes
  - UpSetR
  - ggthemes
  ## APIs
  - bold
  - taxizesoap
  - ridigbio
  - marmap
  - robis
  - rgbif
  - ritis
  ## other utils
  - parallel
  - assertthat
  - extrafont
  - rmarkdown
  - bookdown
  - labmanager
  - progress
  - splines


targets:

  all:
    depends:
      - manuscript.pdf
      - manuscript.docx


### Kozloff species list--------------------------------------------------------

  kozloff_species:
    command: get_kozloff_species("data-raw/Kozloff/Koz_checklist.xlsx")

  kozloff_worms:
    command: add_worms(kozloff_species)

  kozloff_iucn:
    command: add_iucn_status(kozloff_worms)

  kozloff_bold:
    command: find_bold_records(kozloff_worms)

  ## iDigbio -------------------------------------------------------------------
  kozloff_idigbio_raw:
    command: fetch_spp_from_idigbio(kozloff_worms)

  kozloff_idigbio:
    command: filter_raw_records(kozloff_idigbio_raw)

  kozloff_idigbio_in_us:
    command: is_within_eez_records(kozloff_idigbio, map_usa)

  kozloff_idigbio_in_pnw:
    command: is_within_pnw_records(kozloff_idigbio_in_us, map_pnw)

  kozloff_spp_records_idigbio:
    command: get_n_records_in_db(kozloff_worms, kozloff_idigbio_in_pnw, field_name=I("n_idigbio"), region=I("pnw"))

  ## OBIS ----------------------------------------------------------------------
  data/kozloff_obis.feather:
    command: fetch_spp_from_obis(kozloff_worms, "data/kozloff_obis.feather")

  kozloff_obis:
    command: filter_raw_records("data/kozloff_obis.feather")

  kozloff_obis_in_us:
    command: is_within_eez_records(kozloff_obis, map_usa)

  kozloff_obis_in_pnw:
    command: is_within_pnw_records(kozloff_obis_in_us, map_pnw)

  kozloff_spp_records_obis:
    command: get_n_records_in_db(kozloff_worms, kozloff_obis_in_pnw, field_name=I("n_obis"), region=I("pnw"))

  ## GBIF ----------------------------------------------------------------------
  data/kozloff_gbif.feather:
    command: fetch_spp_from_gbif(kozloff_worms, feather_path="data/kozloff_gbif.feather")

  kozloff_gbif:
    command: filter_raw_records("data/kozloff_gbif.feather")

  kozloff_gbif_in_us:
    command: is_within_eez_records(kozloff_gbif, map_usa)

  kozloff_gbif_in_pnw:
    command: is_within_pnw_records(kozloff_gbif_in_us, map_pnw)

  kozloff_spp_records_gbif:
    command: get_n_records_in_db(kozloff_worms, kozloff_gbif_in_pnw, field_name=I("n_gbif"), region=I("pnw"))

  ## overlap with iDigBio query made by geography
  figures/map_kozloff_idigbio.pdf:
    command: map_kozloff(kozloff_idigbio)
    plot:
      height: 8
      width: 12

  ## figures -------------------------------------------------------------------
  figures/kozloff_not_in_idigbio.pdf:
    command: plot_spp_not_in_idigbio(kozloff_spp_records_idigbio)
    plot: true


### Gulf of Mexico species list ------------------------------------------------

  gom_species_raw:
    command: get_gom_species(file="data-raw/GOM/BioGoMx.xls")

  gom_species:
    command: standardize_gom(gom_species_raw)

  gom_worms:
    command: add_worms(gom_species)

  gom_iucn:
    command: add_iucn_status(gom_worms)

  gom_bold:
    command: find_bold_records(gom_worms)

  ## iDigBio -------------------------------------------------------------------
  gom_idigbio_raw:
    command: fetch_spp_from_idigbio(gom_worms)

  gom_idigbio:
    command: filter_raw_records(gom_idigbio_raw)

  gom_idigbio_in_us:
    command: is_within_eez_records(gom_idigbio, map_usa)

  gom_idigbio_in_gom:
    command: is_within_gom_records(gom_idigbio_in_us, map_gom)

  gom_spp_records_idigbio:
    command: get_n_records_in_db(gom_worms, gom_idigbio_in_gom, field_name=I("n_idigbio"), region=I("gom"))

  ## OBIS ----------------------------------------------------------------------
  data/gom_obis.feather:
    command: fetch_spp_from_obis(gom_worms, "data/gom_obis.feather")

  gom_obis:
    command: filter_raw_records("data/gom_obis.feather")

  gom_obis_in_us:
    command: is_within_eez_records(gom_obis, map_usa)

  gom_obis_in_gom:
    command: is_within_gom_records(gom_obis_in_us, map_gom)

  gom_spp_records_obis:
    command: get_n_records_in_db(gom_worms, gom_obis_in_gom, field_name=I("n_obis"), region=I("gom"))

  ## GBIF ----------------------------------------------------------------------
  data/gom_gbif.feather:
    command: fetch_spp_from_gbif(gom_worms, feather_path="data/gom_gbif.feather")

  gom_gbif:
    command: filter_raw_records("data/gom_gbif.feather")

  gom_gbif_in_us:
    command: is_within_eez_records(gom_gbif, map_usa)

  gom_gbif_in_gom:
    command: is_within_gom_records(gom_gbif_in_us, map_gom)

  gom_spp_records_gbif:
    command: get_n_records_in_db(gom_worms, gom_gbif_in_gom, field_name=I("n_gbif"), region=I("gom"))

  ## figures -------------------------------------------------------------------
  figures/gom_not_in_idigbio.pdf:
    command: plot_spp_not_in_idigbio(gom_spp_records_idigbio)
    plot: true

  figures/combined_not_in_idigbio.pdf:
    command: plot_spp_not_in_idigbio_combined(kozloff_spp_records_idigbio, gom_spp_records_idigbio)
    plot:
      height: 8
      width: 12

### ITIS common names of mollusks ----------------------------------------------

  itis_common_names:
    command: get_common_names()

  itis_binomial:
    command: binomial_common_names(itis_common_names)

  itis_worms:
    command: add_worms(itis_binomial)

  itis_bold:
    command: find_bold_records(itis_worms)

  itis_idigbio:
    command: fetch_spp_from_idigbio(itis_worms)

  itis_spp_not_in_idigbio:
    command: spp_not_in_idigbio(itis_worms, itis_idigbio)

### IRL checklist --------------------------------------------------------------

  irl_species:
    command: read_irl_checklist(file="data-raw/IRL/irl_checklist.xlsx")

  irl_worms:
    command: add_worms(irl_species)

  irl_bold:
    command: find_bold_records(irl_worms)

  irl_idigbio:
    command: fetch_spp_from_idigbio(irl_worms)

  irl_obis:
    command: fetch_spp_from_obis(irl_worms)

### American mammals  ----------------------------------------------------------

  data/idigbio_mammals.feather:
    command: convert_to_feather("data-raw/vertebrates/idigbio_mammals_occurrence_raw.csv", feather_out="data/idigbio_mammals.feather")

  mammals_species_idigbio:
    command: read_idigbio_mammals("data/idigbio_mammals.feather")

  mammals_bold_idigbio:
    command: find_bold_records(mammals_species_idigbio, use_worms = I(FALSE))

  ## species list of mammals from the American Society of Mammologists
  ## (http://www.mammalsociety.org/mammals-list)
  ## downloaded on 2017-02-15
  mammals_species_asm:
    command: read_asm_mammals("data-raw/vertebrates/mammals_species_usa.csv")

  mammals_asm_idigbio_raw:
    command: asm_mammals_idigbio(mammals_species_asm)

  mammals_asm_idigbio:
    command: asm_mammals_idigbio_summary(mammals_species_asm, mammals_asm_idigbio_raw)

  mammals_asm_bold:
    ## this produces messages about not finding a valid WoRMS ID, but it's OK here as
    ## it happens as we are trying to look for synonyms in case there is no match
    command: find_bold_mammals(mammals_species_asm)

  mammals_asm_summary:
    command: make_idig_bold_summary(mammals_asm_idigbio, mammals_asm_bold)

  ### American Amphibians ----------------------------------------------------

  amphibian_species:
    command: list_us_amphibians()

  amphibian_idigbio:
    command: fetch_counts_idigbio(amphibian_species)

  amphibian_bold:
    command: fetch_vert_bold(amphibian_species)

  amphibian_summary:
    command: make_idig_bold_summary(amphibian_idigbio, amphibian_bold)

  ### American Birds -----------------------------------------------------------

  bird_species:
    command: list_us_birds(file="data-raw/vertebrates/NACC_list_species_birds.csv")

  bird_idigbio:
    command: fetch_counts_idigbio(bird_species)

  bird_bold:
    command: fetch_vert_bold(bird_species)

  bird_summary:
    command: make_idig_bold_summary(bird_idigbio, bird_bold)

### get species list from the US using iDigBio ---------------------------------

  map_usa:
    command: get_map_usa("data-raw/USA-EEZ/eez.shp")

  coords_idigbio_usa:
    command: get_coords_idigbio_query(map_usa)

  idigbio_database:
    command: create_idigbio_db(coords_idigbio_usa, db_table=I("us_idigbio"), use_cache=I(TRUE))

  idigbio_records_all:
    command: fill_store_idigbio_by_geo(db_table=I("us_idigbio"))
    depends: idigbio_database

  idigbio_records:
    command: filter_idigbio_records(idigbio_records_all, map_usa)

  idigbio_iucn:
    command: add_iucn_status(idigbio_records)

  idigbio_bold:
    command: find_bold_records(idigbio_records)

  ## Gulf of Mexico ------------------------------------------------------------

  map_gom:
    command: get_felder_map_gom("data-raw/mregions_gulf_of_mexico_shp/iho.shp")

  coords_gom_query:
    command: get_coords_idigbio_query(map_gom, cellsize=I(.2))

  idigbio_gom_database:
    command: create_idigbio_db(coords_gom_query, db_table=I("gom_idigbio"), use_cache=I(TRUE))

  idigbio_gom_records_all:
    command: fill_store_idigbio_by_geo(db_table=I("gom_idigbio"))
    depends: idigbio_gom_database

  idigbio_gom_records:
    command: filter_idigbio_records(idigbio_gom_records_all, map_gom)

  obis_gom_records_raw:
    command: fill_store_obis_by_geo(map_gom, use_cache=I(TRUE))

  obis_gom_records:
    command: add_worms(obis_gom_records_raw)

  data/compare_database_coverage.csv:
    command: generate_upsetr_csv(list = gom_worms, idigbio = idigbio_gom_records, obis = obis_gom_records, file="data/compare_database_coverage.csv")

  figures/gom_database_coverage.pdf:
    command: plot_upsetr("data/compare_database_coverage.csv")
    plot: true

  ## Pacific Northwest ---------------------------------------------------------

  map_pnw:
    command: get_map_pnw()

  coords_pnw_query:
    command: get_coords_idigbio_query(map_pnw, cellsize=I(.5))

  idigbio_pnw_database:
    command: create_idigbio_db(coords_pnw_query, db_table=I("kozloff_idigbio"), use_cache=I(TRUE))

  idigbio_pnw_records_all:
    command: fill_store_idigbio_by_geo(db_table=I("kozloff_idigbio"))
    depends: idigbio_pnw_database

  idigbio_pnw_records:
    command: filter_idigbio_records(idigbio_pnw_records_all, map_pnw)

  obis_kozloff_records_raw:
    command: fill_store_obis_by_geo(map_pnw, use_cache=I(TRUE))

  obis_kozloff_records:
    command: add_worms(obis_kozloff_records_raw)

  data/compare_database_coverage_kozloff.csv:
    command: generate_upsetr_csv(list = kozloff_worms, idigbio = idigbio_pnw_records, obis = obis_kozloff_records, file = "data/compare_database_coverage_kozloff.csv")

  figures/kozloff_database_coverage.pdf:
    command: plot_upsetr("data/compare_database_coverage_kozloff.csv")
    plot: true

  ## Synthesis -----------------------------------------------------------------

  figures/database_coverage.pdf:
    command: combine_plots("figures/gom_database_coverage.pdf", "figures/kozloff_database_coverage.pdf", output="figures/database_coverage.pdf")

  species_in_common:
    command: get_species_in_common(gom_worms, idigbio_gom_records, obis_gom_records, kozloff_worms, idigbio_pnw_records, obis_kozloff_records)

  database_overlap:
    command: compare_database_overlap(gom_worms, kozloff_worms, idigbio_gom_records, obis_gom_records, idigbio_pnw_records, obis_kozloff_records)

  figures/database_overlap.pdf:
    command: plot_database_overlap(database_overlap)
    plot:
      width: 12
      height: 4

  idigbio_invert_summary:
    command: plot_idigbio_invert_summary(idigbio_records, idigbio_bold)

  idigbio_samples_through_time_data:
    command: make_knowledge_through_time_idigbio(idigbio_records_all)

  idigbio_samples_through_time:
    command: plot_cum_samples_through_time(idigbio_samples_through_time_data, facet=I(FALSE))

  idigbio_species_through_time:
    command: plot_cum_spp_through_time(idigbio_samples_through_time_data, facet=I(FALSE))

  figures/idigbio_through_time.pdf:
    command: combine_cowplots(idigbio_samples_through_time, idigbio_species_through_time)
    plot:
      width: 12
      height: 6

  idigbio_identification_level_through_time:
    command: data_identification_level_through_time(idigbio_records)

  figures/idigbio_identification_level_through_time.pdf:
    command: plot_identification_level_through_time(idigbio_identification_level_through_time)
    plot:
      width: 10
      height: 6

### summary tables
  # table_idigbio_species_sequenced:
  #   command: make_table_bold_records_per_idigbio_species(global=global_idigbio_species_with_bold_info, east_coast=east_idigbio_species_with_bold_info, west_coast=west_idigbio_species_with_bold_info, florida=florida_idigbio_species_with_bold_info)

  # figures/plot_idigbio_species_sequenced.pdf:
  #   command: make_plot_bold_records_per_idigbio_species(table_idigbio_species_sequenced)
  #   plot: true

  # idigbio_species_list_dates:
  #   command: assemble_idigbio_species_list_dates(global_idigbio_species_with_worms_info)
  #   depends: idigbio_records

  # figures/plot_idigbio_species_dates.pdf:
  #   command: make_plot_idigbio_records_per_date(idigbio_species_list_dates)
  #   plot:
  #     width: 12
  #     height: 8

  figures/proportion_barcoded.pdf:
    command: summary_bold_status(gom_bold, kozloff_bold, idigbio_bold)
    plot: true

  #table_records_per_species:
  #   command: make_table_records_per_species()
  #   depends: bold_records_for_idigbio_species


### plankton data
  plankton_ids:
    command: get_plankton_identifications()

  prop_plankton_with_species_match_by_phylum:
    command: calc_prop_plankton_with_species_match_by_phylum(plankton_ids)

  prop_plankton_with_multi_species_match:
    command: calc_prop_plankton_with_multi_species_match(plankton_ids)

  plankton_geo_distances:
    command: calc_plankton_geo_distances(plankton_ids)

### map sampling effort --------------------------------------------------------

  data_map_sampling_effort:
    command: make_data_map_sampling_effort(idigbio_records)

  data_map_diversity:
    command: make_data_map_diversity(idigbio_records)

  data_map_standardized_diversity:
    command: make_data_map_standardized_diversity(data_map_sampling_effort, data_map_diversity)

  map_sampling_effort:
    command: make_heatmap_sampling(data_map_sampling_effort, I("Number of samples"))

  map_diversity:
    command: make_heatmap_sampling(data_map_diversity, I("Number of species"))

  figures/map_diversity_sampling.pdf:
    command: combine_cowplots(map_sampling_effort, map_diversity, nrow=I(2), common_legend=I(FALSE))
    plot:
      width: 6
      height: 7

  knowledge_through_time:
    command: make_knowledge_through_time(gom_idigbio_in_us, kozloff_idigbio_in_us, gom_gbif_in_us, kozloff_gbif_in_us, gom_worms, kozloff_worms)

  figures/cum_spp_through_time.pdf:
    command: plot_cum_spp_through_time(knowledge_through_time)
    plot: true

  figures/cum_samples_through_time.pdf:
    command: plot_cum_samples_through_time(knowledge_through_time)
    plot: true

  figures/new_spp_per_effort.pdf:
    command: plot_new_effort(knowledge_through_time)
    plot:
      width: 12
      height: 8

  figures/cum_frac_through_time.pdf:
    command: plot_cum_frac_through_time(knowledge_through_time)
    plot: true

  figures/change_trend_through_time.pdf:
    command: plot_change_trend_through_time(knowledge_through_time)
    plot:
      width: 12
      height: 8

### plot summary database ------------------------------------------------------

  summary_richness_per_db_gom:
    command: summarize_richness_per_db(gom_bold, gom_spp_records_idigbio, gom_spp_records_obis, gom_spp_records_gbif, region=I("gom"))

  summary_richness_per_db_koz:
    command: summarize_richness_per_db(kozloff_bold, kozloff_spp_records_idigbio, kozloff_spp_records_obis, kozloff_spp_records_gbif, region=I("pnw"))

  plot_richness_per_db_koz:
    command: plot_richness_per_db(summary_richness_per_db_koz, region=I("pnw"))

  plot_richness_per_db_gom:
    command: plot_richness_per_db(summary_richness_per_db_gom, region=I("gom"))

  figures/richness_per_db.pdf:
    command: combine_cowplots(plot_richness_per_db_gom, plot_richness_per_db_koz)
    plot:
      width: 12
      height: 10

### plot sampling effort (correlation between number of samples vs number species

  figures/plot_sampling_effort.pdf:
    command: plot_sampling_effort(data_map_standardized_diversity)
    plot: true

### in text statistics ---------------------------------------------------------

  prop_plankton_with_match:
    command: calc_prop_plankton_with_species_match(plankton_ids)

  stat_bold:
    command: make_stat_bold(gom_bold, kozloff_bold, gom_worms, kozloff_worms)

  prop_singleton_species:
    command: calc_prop_nspecimens_species(idigbio_records, n_specimens=I(1))

  prop_10_specimens_species:
    command: calc_prop_nspecimens_species(idigbio_records, n_specimens=I(10))

  prop_30_specimens_species:
    command: calc_prop_nspecimens_species(idigbio_records, n_specimens=I(30))

  records_rare_phyla:
    command: calc_records_rare_phyla(idigbio_records)

  n_idigbio_phyla:
    command: calc_n_idigbio_phyla(idigbio_records)

  prop_species_not_collected_since_1980:
    command: calc_prop_species_not_collected_since(idigbio_records, I(1980))

  n_spp_comparison:
    command: calc_n_spp_comparison(idigbio_samples_through_time_data)

  #prop_species_not_collected_since_1990:
  #  command: calc_prop_species_not_collected_since(idigbio_species_list_dates, I(1990))

  recently_collected:
    command: not_in_list_collected_recently(database_overlap)

  not_really_in_database:
    command: get_not_really_in_database(database_overlap, map_usa)

### Attributions ---------------------------------------------------------------

  idigbio_records_attributions:
    command: idigbio_attribution(idigbio_records)

  idigbio_gom_records_attributions:
    command: idigbio_attribution(idigbio_gom_records)

  idigbio_pnw_records_attributions:
    command: idigbio_attribution(idigbio_pnw_records)




### Manuscript -----------------------------------------------------------------

  manuscript.md:
    depends:
      - idigbio_records
      - idigbio_gom_records
      - obis_gom_records
      - idigbio_pnw_records
      - obis_kozloff_records
      - gom_worms
      - kozloff_worms
      - mammals_species_asm
      - amphibian_summary
      - stat_bold
      - prop_singleton_species
      - prop_10_specimens_species
      - prop_30_specimens_species
      - n_idigbio_phyla
      - records_rare_phyla
      - prop_species_not_collected_since_1980
      - n_spp_comparison
      - species_in_common
      - summary_richness_per_db_gom
      - summary_richness_per_db_koz
      - recently_collected
      - not_really_in_database
      ## figures
      - figures/map_diversity_sampling.pdf
      - figures/proportion_barcoded.pdf
      - figures/richness_per_db.pdf
      - figures/database_coverage.pdf
      - figures/database_overlap.pdf
      - figures/idigbio_through_time.pdf
      - figures/idigbio_identification_level_through_time.pdf
      ## attributions
      - idigbio_records_attributions
      - idigbio_gom_records_attributions
      - idigbio_pnw_records_attributions
    knitr: true

  manuscript.pdf:
    command: render("manuscript.md")

  manuscript.docx:
    command: render("manuscript.md", output_format=I("bookdown::word_document2"))
