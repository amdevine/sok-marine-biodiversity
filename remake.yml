sources:
  - R/

packages:
  ## data I/O
  - readxl
  - readr
  - feather
  - RSQLite
  - storr
  - bold
  - tibble
  ## geospatial tools
  - raster
  - sp
  - maptools
  - maps
  - geojsonio
  - lawn
  ## data manipulation
  - dplyr
  - tidyr
  - lubridate
  ## data visualization
  - ggplot2
  - viridis
  ## APIs
  - taxizesoap
  - ridigbio
  - marmap
  - robis
  - rgbif
  - ritis
  ## other utils
  - rmarkdown
  - labmanager


targets:
  all:
    depends:
      - manuscript.pdf
      - manuscript.docx



  #### get BOLD specimen data for most marine groups ---------------------------
  acanthocephala_raw:
    command: bold_specimens_raw(I("Acanthocephala"))
    cleanup_level: purge

  brachiopoda_raw:
    command: bold_specimens_raw(I("Brachiopoda"))
    cleanup_level: purge

  cephalorhyncha_raw:
    command: bold_specimens_raw(I("Cephalorhyncha"))
    cleanup_level: purge

  cycliophora_raw:
    command: bold_specimens_raw(I("Cycliophora"))
    cleanup_level: purge

  dicyemida_raw:
    command: bold_specimens_raw(I("Rhombozoa"))
    cleanup_level: purge

  hemichordata_raw:
    command: bold_specimens_raw(I("Hemichordata"))
    cleanup_level: purge

  ## TODO -- nematoda_raw:

  orthonectida_raw:
    command: bold_specimens_raw(I("Orthonectida"))
    cleanup_level: purge

  placozoa_raw:
    command: bold_specimens_raw(I("Placozoa"))
    cleanup_level: purge

  platyhelminthes_raw:
    command: bold_specimens_raw(I("Platyhelminthes"))
    cleanup_level: purge

  xenacoelomorpha_raw:
    command: bold_specimens_raw(I("Xenacoelomorpha"))
    cleanup_level: purge

  echinodermata_raw:
    command: bold_specimens_raw(I("Echinodermata"))
    cleanup_level: purge

  polychaeta_raw:
    command: bold_specimens_raw(I("Polychaeta"))
    cleanup_level: purge

  cnidaria_raw:
    command: bold_specimens_raw(I("Cnidaria"))
    cleanup_level: purge

  nemertea_raw:
    command: bold_specimens_raw(I("Nemertea"))
    cleanup_level: purge

  ctenophora_raw:
    command: bold_specimens_raw(I("Ctenophora"))
    cleanup_level: purge

  porifera_raw:
    command: bold_specimens_raw(I("Porifera"))
    cleanup_level: purge

  malacostraca_raw:
    command: bold_specimens_raw(I("Malacostraca"))

  sipuncula_raw:
    command: bold_specimens_raw(I("Sipuncula"))

  chaetognatha_raw:
    command: bold_specimens_raw(I("Chaetognatha"))

  mollusca_raw:
    command: bold_specimens_raw(I("Mollusca"))
    cleanup_level: purge

  phoronida_raw:
    command: bold_specimens_raw(I("Phoronida"))
    cleanup_level: purge

  entoprocta_raw:
    command: bold_specimens_raw(I("Entoprocta"))
    cleanup_level: purge

  bryozoa_raw:
    command: bold_specimens_raw(I("Bryozoa"))
    cleanup_level: purge

  gnathostomulida_raw:
    command: bold_specimens_raw(I("Gnathostomulida"))
    cleanup_level: purge

  gastrotricha_raw:
    command: bold_specimens_raw(I("Gastrotricha"))
    cleanup_level: purge

  mammalia_raw:
    command: bold_specimens_raw(I("Mammalia"))
    cleanup_level: purge

  reptilia_raw:
    command: bold_specimens_raw(I("Reptilia"))
    cleanup_level: purge

  amphibia_raw:
    command: bold_specimens_raw(I("Amphibia"))
    cleanup_level: purge

  aves_raw:
    command: bold_specimens_raw(I("Aves"))
    cleanup_level: purge

  bold_data:
    command: assemble_bold_data(acanthocephala_raw, brachiopoda_raw, cephalorhyncha_raw, cycliophora_raw, dicyemida_raw, hemichordata_raw, orthonectida_raw, platyhelminthes_raw, xenacoelomorpha_raw, echinodermata_raw, polychaeta_raw, cnidaria_raw, nemertea_raw, ctenophora_raw, porifera_raw, malacostraca_raw, chaetognatha_raw, mollusca_raw, phoronida_raw, entoprocta_raw, bryozoa_raw, gnathostomulida_raw, mammalia_raw, reptilia_raw, amphibia_raw, aves_raw)

  stats_bold_data:
    command: get_stats_bold(bold_data)

  table_proportion_barcoded_by_phylum:
    command: make_table_proportion_barcoded_by_phylum(stats_bold_data, worms="data-raw/20160929_worms_stats.csv", others="data-raw/20160929_other_taxa_stats.csv")

  figures/proportion_barcoded_by_phylum.pdf:
    command: plot_proportion_barcoded_by_phylum(table_proportion_barcoded_by_phylum)
    plot: true

  level_identification:
    command: get_level_identification(bold_data)

  figures/proportion_level_identification.pdf:
    command: plot_level_identification(level_identification)
    plot: true

### Kozloff species list--------------------------------------------------------

  kozloff_species:
    command: get_kozloff_species("data-raw/Kozloff/Koz_checklist.xlsx")

  # overlap with iDigBio query made by geography
  kozloff_idigbio_overlap:
    command: calc_kozloff_idigbio_overlap(kozloff_species, global_idigbio_species_with_worms_info)

  # get idigbio records based on species names
  kozloff_worms:
    command: add_worms(kozloff_species)

  kozloff_idigbio:
    command: fetch_spp_from_idigbio(kozloff_species)

  kozloff_obis:
    command: fetch_spp_from_obis(kozloff_worms)

  data/kozloff_gbif.feather:
    command: fetch_spp_from_gbif(kozloff_worms, feather_path="data/kozloff_gbif.feather")

  kozloff_gbif:
    command: filter_gbif("data/kozloff_gbif.feather")

  kozloff_gbif_in_us:
    command: us_gbif(kozloff_gbif, map_usa)

  kozloff_idigbio_species_list:
    command: extract_species_from_idigbio(kozloff_idigbio, kozloff_species)

  kozloff_spp_not_in_us:
    command: spp_not_in_us(kozloff_idigbio)

  kozloff_bold:
    command: add_bold(kozloff_worms)

  figures/map_kozloff_idigbio.pdf:
    command: map_kozloff(kozloff_idigbio)
    plot:
      height: 8
      width: 12

  # number/proportion of species listed in Kozloff, but not found in iDigBio
  # (complete list, beyond the search done on geography)
  kozloff_spp_not_in_idigbio:
    command: spp_not_in_idigbio(kozloff_species, kozloff_idigbio)

  prop_kozloff_not_in_idigbio:
    command: calc_prop_kozloff_not_in_idigbio(kozloff_spp_not_in_idigbio)

  figures/kozloff_not_in_idigbio.pdf:
    command: plot_spp_not_in_idigbio(kozloff_spp_not_in_idigbio)
    plot: true

### ITIS common names of mollusks ----------------------------------------------

  itis_common_names:
    command: get_common_names()

  itis_binomial:
    command: binomial_common_names(itis_common_names)

  itis_worms:
    command: add_worms(itis_binomial)

  itis_bold:
    command: add_bold(itis_worms)

  itis_idigbio:
    command: fetch_spp_from_idigbio(itis_worms)

  itis_spp_not_in_idigbio:
    command: spp_not_in_idigbio(itis_worms, itis_idigbio)

### Gulf of Mexico species list ------------------------------------------------

  gom_species_raw:
    command: get_gom_species(file="data-raw/GOM/BioGoMx.xls")

  gom_species:
    command: standardize_gom(gom_species_raw)

  gom_worms:
    command: add_worms(gom_species)

  gom_bold:
    command: add_bold(gom_worms)

  ## iDigBio -------------------------------------------------------------------
  gom_idigbio_raw:
    command: fetch_spp_from_idigbio(gom_worms)

  gom_idigbio:
    command: filter_raw_records(gom_idigbio_raw)

  gom_idigbio_in_us:
    command: is_in_eez_records(gom_idigbio, map_usa)

  gom_spp_records_idigbio:
    command: get_n_records_in_db(gom_worms, gom_idigbio_in_us, field_name=I("n_idigbio"))

  ## OBIS ----------------------------------------------------------------------
  data/gom_obis.feather:
    command: fetch_spp_from_obis(gom_worms, "data/gom_obis.feather")

  gom_obis:
    command: filter_raw_records("data/gom_obis.feather")

  gom_obis_in_us:
    command: is_in_eez_records(gom_obis, map_usa)

  gom_spp_records_obis:
    command: get_n_records_in_db(gom_worms, gom_obis_in_us, field_name=I("n_obis"))

  ## GBIF ----------------------------------------------------------------------
  data/gom_gbif.feather:
    command: fetch_spp_from_gbif(gom_worms, feather_path="data/gom_gbif.feather")

  gom_gbif:
    command: filter_raw_records("data/gom_gbif.feather")

  gom_gbif_in_us:
    command: is_in_eez_records(gom_gbif, map_usa)

  gom_spp_records_gbif:
    command: get_n_records_in_db(gom_worms, gom_gbif_in_us, field_name=I("n_gbif"))

  ## figures -------------------------------------------------------------------
  figures/gom_not_in_idigbio.pdf:
    command: plot_spp_not_in_idigbio(gom_spp_records_idigbio)
    plot: true

  figures/combined_not_in_idigbio.pdf:
    command: plot_spp_not_in_idigbio_combined(kozloff_spp_not_in_idigbio, gom_spp_records_idigbio)
    plot:
      height: 8
      width: 12

### IRL checklist --------------------------------------------------------------
  irl_species:
    command: read_irl_checklist(file="data-raw/IRL/irl_checklist.xlsx")

  irl_worms:
    command: add_worms(irl_species)

  irl_bold:
    command: add_bold(irl_worms)

  irl_idigbio:
    command: fetch_spp_from_idigbio(irl_worms)

  irl_obis:
    command: fetch_spp_from_obis(irl_worms)

### American mammals  ----------------------------------------------------------

  data/idigbio_mammals.feather:
    command: convert_to_feather("data-raw/vertebrates/idigbio_mammals_occurrence_raw.csv", feather_out="data/idigbio_mammals.feather")

  mammals_species:
    command: read_idigbio_mammals("data/idigbio_mammals.feather")

  mammals_bold:
    command: add_bold(mammals_species, use_worms = I(FALSE))



### get species list from the US using iDigBio ---------------------------------

  map_usa:
    command: get_map_usa("data-raw/USA-EEZ/eez.shp")

  idigbio_records_raw:
    command: assemble_idigbio_records("data-raw/idigbio-search/idigbio_search.csv")

  idigbio_records:
    command: is_in_eez(idigbio_records_raw, map_usa)

### global list
  global_idigbio_species_list:
    command: assemble_idigbio_species_list(geo_filter=I("global"))
    depends: idigbio_records

  global_idigbio_species_with_worms_info:
    command: add_worms(global_idigbio_species_list)

  global_idigbio_species_with_bold_info:
    command: add_bold(global_idigbio_species_with_worms_info)

### east coast list
  east_idigbio_species_list:
    command: assemble_idigbio_species_list(geo_filter=I("east_coast"))
    depends: idigbio_records

  east_idigbio_species_with_worms_info:
    command: add_worms(east_idigbio_species_list)

  east_idigbio_species_with_bold_info:
    command: add_bold(east_idigbio_species_with_worms_info)

### west coast list
  west_idigbio_species_list:
    command: assemble_idigbio_species_list(geo_filter=I("west_coast"))
    depends: idigbio_records

  west_idigbio_species_with_worms_info:
    command: add_worms(west_idigbio_species_list)

  west_idigbio_species_with_bold_info:
    command: add_bold(west_idigbio_species_with_worms_info)

### florida list
  florida_idigbio_species_list:
    command: assemble_idigbio_species_list(geo_filter=I("florida"))
    depends: idigbio_records

  florida_idigbio_species_with_worms_info:
    command: add_worms(florida_idigbio_species_list)

  florida_idigbio_species_with_bold_info:
    command: add_bold(florida_idigbio_species_with_worms_info)

### summary tables
  table_idigbio_species_sequenced:
    command: make_table_bold_records_per_idigbio_species(global=global_idigbio_species_with_bold_info, east_coast=east_idigbio_species_with_bold_info, west_coast=west_idigbio_species_with_bold_info, florida=florida_idigbio_species_with_bold_info)

  figures/plot_idigbio_species_sequenced.pdf:
    command: make_plot_bold_records_per_idigbio_species(table_idigbio_species_sequenced)
    plot: true

  idigbio_species_list_dates:
    command: assemble_idigbio_species_list_dates(global_idigbio_species_with_worms_info)
    depends: idigbio_records

  figures/plot_idigbio_species_dates.pdf:
    command: make_plot_idigbio_records_per_date(idigbio_species_list_dates)
    plot:
      width: 12
      height: 8

  figures/proportion_barcoded.pdf:
    command: make_plot_proportion_barcoded(table_idigbio_species_sequenced, prop_plankton_with_species_match_by_phylum)
    plot: true

  #table_records_per_species:
  #   command: make_table_records_per_species()
  #   depends: bold_records_for_idigbio_species

  proportion_barcoded_summary:
    command: make_proportion_barcoded_summary(table_proportion_barcoded_by_phylum, table_idigbio_species_sequenced)

### plankton data
  plankton_ids:
    command: get_plankton_identifications()

  prop_plankton_with_species_match_by_phylum:
    command: calc_prop_plankton_with_species_match_by_phylum(plankton_ids)

  prop_plankton_with_multi_species_match:
    command: calc_prop_plankton_with_multi_species_match(plankton_ids)

  plankton_geo_distances:
    command: calc_plankton_geo_distances(plankton_ids)

### map sampling effort --------------------------------------------------------

  sampling_maps:
    depends:
      - figures/map_sampling_effort.pdf
      - figures/map_diversity.pdf
      - figures/map_sampling.pdf


  data_map_sampling_effort:
    command: make_data_map_sampling_effort()
    depends: idigbio_records

  data_map_diversity:
    command: make_data_map_diversity()
    depends: idigbio_records

  data_map_standardized_diversity:
    command: make_data_map_standardized_diversity(data_map_sampling_effort, data_map_diversity)

  figures/map_sampling_effort.pdf:
    command: make_heatmap_sampling(data_map_sampling_effort, I("Number of samples"))
    plot: true

  figures/map_diversity.pdf:
    command: make_heatmap_sampling(data_map_diversity, I("Number of species"))
    plot: true

  figures/map_sampling.pdf:
    command: make_heatmap_sampling(data_map_standardized_diversity, I("Diversity"))
    plot: true

### plot summary database ------------------------------------------------------

  summary_richness_per_db:
    command: summarize_richness_per_db(gom_bold, gom_spp_records_idigbio, gom_spp_records_obis, gom_spp_records_gbif)

  figures/plot_richness_per_db.pdf:
    command: plot_richness_per_db(summary_richness_per_db)
    plot: true

### plot sampling effort -------------------------------------------------------

  figures/plot_sampling_effort.pdf:
    command: plot_sampling_effort(data_map_standardized_diversity)
    plot: true

### in text statistics ---------------------------------------------------------

  in_text_stats:
    depends:
      - average_prop_species_seq
      - n_esus
      - n_larvae
      - prop_plankton_with_match
      - prop_singleton_species
      - prop_species_not_collected_since_1950

  average_prop_species_seq:
    command: calc_average_prop_species_seq(table_idigbio_species_sequenced)

  n_esus:
    command: calc_n_esus()

  n_larvae:
    command: calc_n_larvae()

  prop_plankton_with_match:
    command: calc_prop_plankton_with_species_match(plankton_ids)

  prop_singleton_species:
    command: calc_prop_singleton_species(idigbio_species_list_dates)

  prop_species_not_collected_since_1950:
    command: calc_prop_species_not_collected_since(idigbio_species_list_dates, I(1950))

  prop_species_not_collected_since_1990:
    command: calc_prop_species_not_collected_since(idigbio_species_list_dates, I(1990))

### Manuscript -----------------------------------------------------------------

  manuscript.md:
    depends: in_text_stats
    knitr: true

  manuscript.pdf:
    command: render("manuscript.md")

  manuscript.docx:
    command: render("manuscript.md", output_format=I("word_document"))
