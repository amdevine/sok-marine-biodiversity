sources:
  - R/

packages:
  - readxl
  - readr
  - dplyr
  - ggplot2
  - RSQLite
  - taxizesoap
  - storr
  - bold
  - tibble
  - tidyr
  - ridigbio

targets:
  all:
    depends:
      - irl_species_in_bold

  irl_checklist:
    command: read_irl_checklist(file="data-raw/Species List Database Post V1.xlsx")

  data/bold_database.sqlite:
    command: create_bold_db(path=I("data-raw/BOLD"))

  joined_data:
    command: create_joined_data(irl_checklist, "data/bold_database.sqlite")

  species_list:
    command: join_species("data/bold_database.sqlite")
    depends: joined_data

  fill_synonym_store:
    command: get_synonym_store(irl_checklist)

  fill_classification_store:
    command: get_classification_store(irl_checklist)

  synonym_table:
    command: make_synonym_table(store_path=I("data/synonym_storr"), database_path=I("data/bold_database.sqlite"))
    depends: fill_synonym_store

  synonym_list:
    command: join_synonyms("data/bold_database.sqlite")
    depends: synonym_table

  fill_bold_specimen_store:
    command: get_bold_specimens_store(irl_checklist)

  irl_species_in_bold:
    command: get_irl_species_in_bold()
    depends:
      - fill_synonym_store
      - fill_classification_store
      - fill_bold_specimen_store

  barcode_data:
    command: assemble_barcode_data(worms="data-raw/20160929_worms_stats.csv", bold="data-raw/20160929_bold_bin_stats.csv", other="data-raw/20160929_other_taxa_stats.csv")

  figures/plot_barcode_data.pdf:
    command: plot_barcoded_species(barcode_data)
    plot: true

  #### get BOLD specimen data for most marine groups ---------------------------
  acanthocephala_raw:
    command: bold_specimens_raw(I("Acanthocephala"))
    cleanup_level: purge

  brachiopoda_raw:
    command: bold_specimens_raw(I("Brachiopoda"))
    cleanup_level: purge

  cephalorhyncha_raw:
    command: bold_specimens_raw(I("Cephalorhyncha"))
    cleanup_level: purge

  cycliophora_raw:
    command: bold_specimens_raw(I("Cycliophora"))
    cleanup_level: purge

  dicyemida_raw:
    command: bold_specimens_raw(I("Rhombozoa"))
    cleanup_level: purge

  hemichordata_raw:
    command: bold_specimens_raw(I("Hemichordata"))
    cleanup_level: purge

  ## TODO -- nematoda_raw:

  orthonectida_raw:
    command: bold_specimens_raw(I("Orthonectida"))
    cleanup_level: purge

  placozoa_raw:
    command: bold_specimens_raw(I("Placozoa"))
    cleanup_level: purge

  platyhelminthes_raw:
    command: bold_specimens_raw(I("Platyhelminthes"))
    cleanup_level: purge

  xenacoelomorpha_raw:
    command: bold_specimens_raw(I("Xenacoelomorpha"))
    cleanup_level: purge

  echinodermata_raw:
    command: bold_specimens_raw(I("Echinodermata"))
    cleanup_level: purge

  polychaeta_raw:
    command: bold_specimens_raw(I("Polychaeta"))
    cleanup_level: purge

  cnidaria_raw:
    command: bold_specimens_raw(I("Cnidaria"))
    cleanup_level: purge

  nemertea_raw:
    command: bold_specimens_raw(I("Nemertea"))
    cleanup_level: purge

  ctenophora_raw:
    command: bold_specimens_raw(I("Ctenophora"))
    cleanup_level: purge

  porifera_raw:
    command: bold_specimens_raw(I("Porifera"))
    cleanup_level: purge

  malacostraca_raw:
    command: bold_specimens_raw(I("Malacostraca"))

  sipuncula_raw:
    command: bold_specimens_raw(I("Sipuncula"))

  chaetognatha_raw:
    command: bold_specimens_raw(I("Chaetognatha"))

  mollusca_raw:
    command: bold_specimens_raw(I("Mollusca"))
    cleanup_level: purge

  phoronida_raw:
    command: bold_specimens_raw(I("Phoronida"))
    cleanup_level: purge

  entoprocta_raw:
    command: bold_specimens_raw(I("Entoprocta"))
    cleanup_level: purge

  bryozoa_raw:
    command: bold_specimens_raw(I("Bryozoa"))
    cleanup_level: purge

  gnathostomulida_raw:
    command: bold_specimens_raw(I("Gnathostomulida"))
    cleanup_level: purge

  gastrotricha_raw:
    command: bold_specimens_raw(I("Gastrotricha"))
    cleanup_level: purge

  mammalia_raw:
    command: bold_specimens_raw(I("Mammalia"))
    cleanup_level: purge

  reptilia_raw:
    command: bold_specimens_raw(I("Reptilia"))
    cleanup_level: purge

  amphibia_raw:
    command: bold_specimens_raw(I("Amphibia"))
    cleanup_level: purge

  aves_raw:
    command: bold_specimens_raw(I("Aves"))
    cleanup_level: purge

  bold_data:
    command: assemble_bold_data(acanthocephala_raw, brachiopoda_raw, cephalorhyncha_raw, cycliophora_raw, dicyemida_raw, hemichordata_raw, orthonectida_raw, platyhelminthes_raw, xenacoelomorpha_raw, echinodermata_raw, polychaeta_raw, cnidaria_raw, nemertea_raw, ctenophora_raw, porifera_raw, malacostraca_raw, chaetognatha_raw, mollusca_raw, phoronida_raw, entoprocta_raw, bryozoa_raw, gnathostomulida_raw, mammalia_raw, reptilia_raw, amphibia_raw, aves_raw)

  stats_bold_data:
    command: get_stats_bold(bold_data)

  figures/proportion_barcoded_by_phylum.pdf:
    command: plot_proportion_barcoded_by_phylum(stats_bold_data,  worms="data-raw/20160929_worms_stats.csv",others="data-raw/20160929_other_taxa_stats.csv")
    plot: true

  level_identification:
    command: get_level_identification(bold_data)

  figures/proportion_level_identification.pdf:
    command: plot_level_identification(level_identification)
    plot: true

  ### get species list from the US using iDigBio
  idigbio_records:
    depends:
      - acanthocephala_idigbio_records
      - brachiopoda_idigbio_records
      - cephalorhyncha_idigbio_records
      - cycliophora_idigbio_records
      - dicyemida_idigbio_records
      - hemichordata_idigbio_records
      - orthonectida_idigbio_records
      - platyhelminthes_idigbio_records
      - xenacoelomorpha_idigbio_records
      - polychaeta_idigbio_records
      - porifera_idigbio_records
      # TODO - malacostraca_idigbio_records
      - entoprocta_idigbio_records
      - bryozoa_idigbio_records
      - gnathostomulida_idigbio_records
      - echinodermata_idigbio_records
      - nemertea_idigbio_records
      - phoronida_idigbio_records
      - ctenophora_idigbio_records
      - chaetognatha_idigbio_records
      - cnidaria_idigbio_records


  acanthocephala_idigbio_records:
    command: assemble_idigbio_records(I("Acanthocephala"), I("phylum"))

  brachiopoda_idigbio_records:
    command: assemble_idigbio_records(I("Brachiopoda"), I("phylum"))

  cephalorhyncha_idigbio_records:
    command: assemble_idigbio_records(I("Cephalorhyncha"), I("phylum"))

  cycliophora_idigbio_records:
    command: assemble_idigbio_records(I("Cycliophora"), I("phylum"))

  dicyemida_idigbio_records:
    command: assemble_idigbio_records(I("Dicyemida"), I("phylum"))

  hemichordata_idigbio_records:
    command: assemble_idigbio_records(I("Hemichordata"), I("phylum"))

  orthonectida_idigbio_records:
    command: assemble_idigbio_records(I("Orthonectida"), I("phylum"))

  platyhelminthes_idigbio_records:
    command: assemble_idigbio_records(I("Platyhelminthes"), I("phylum"))

  xenacoelomorpha_idigbio_records:
    command: assemble_idigbio_records(I("Xenacoelomorpha"), I("phylum"))

  polychaeta_idigbio_records:
    command: assemble_idigbio_records(I("Polychaeta"), I("class"))

  porifera_idigbio_records:
    command: assemble_idigbio_records(I("Porifera"), I("phylum"))

  entoprocta_idigbio_records:
    command: assemble_idigbio_records(I("Entoprocta"), I("phylum"))

  bryozoa_idigbio_records:
    command: assemble_idigbio_records(I("Bryozoa"), I("phylum"))

  gnathostomulida_idigbio_records:
    command: assemble_idigbio_records(I("Gnathostomulida"), I("phylum"))

  #_idigbio_records:
  #  command: assemble_idigbio_records(I(""), I("class"))

  echinodermata_idigbio_records:
    command: assemble_idigbio_records(I("Echinodermata"), I("phylum"))

  nemertea_idigbio_records:
    command: assemble_idigbio_records(I("Nemertea"), I("phylum"))

  phoronida_idigbio_records:
    command: assemble_idigbio_records(I("Phoronida"), I("phylum"))

  ctenophora_idigbio_records:
    command: assemble_idigbio_records(I("Ctenophora"), I("phylum"))

  chaetognatha_idigbio_records:
    command: assemble_idigbio_records(I("Chaetognatha"), I("phylum"))

  cnidaria_idigbio_records:
    command: assemble_idigbio_records(I("Cnidaria"), I("phylum"))

  idigbio_species_list:
    command: assemble_idigbio_species_list()
    depends: idigbio_records

  idigbio_species_with_worms_info:
    command: add_worms_info(idigbio_species_list)

  idigbio_species_with_bold_info:
    command: add_bold_info(idigbio_species_with_worms_info)

  # table_records_per_species:
  #   command: make_table_records_per_species()
  #   depends: bold_records_for_idigbio_species
